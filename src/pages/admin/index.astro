---
export const prerender = false;
import { validateSession } from "@utils/auth";

const token = Astro.cookies.get("admin_session")?.value ?? "";
const username = validateSession(token);
if (!username) {
  return Astro.redirect("/admin/login/");
}
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åå°ç®¡ç† - Twilight Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
    .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 0 24px; height: 60px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .admin-header h1 { font-size: 20px; font-weight: 600; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-right span { font-size: 14px; opacity: 0.9; }
    .header-right a, .header-right button { color: #fff; text-decoration: none; font-size: 14px; background: rgba(255,255,255,0.2); border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .header-right a:hover, .header-right button:hover { background: rgba(255,255,255,0.3); }
    .admin-nav { background: #fff; border-bottom: 1px solid #e8e8e8; padding: 0 24px; display: flex; gap: 0; overflow-x: auto; }
    .admin-nav a { padding: 14px 20px; text-decoration: none; color: #666; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.2s; }
    .admin-nav a:hover { color: #667eea; background: #f8f9ff; }
    .admin-nav a.active { color: #667eea; border-bottom-color: #667eea; }
    .admin-content { max-width: 1200px; margin: 24px auto; padding: 0 24px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .stat-card .stat-label { font-size: 13px; color: #999; margin-bottom: 8px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 700; color: #333; }
    .stat-card .stat-icon { font-size: 32px; float: right; opacity: 0.3; }
    .section-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; }
    .section-card h3 { font-size: 16px; color: #333; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
    .content-link { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #333; transition: background 0.2s; margin-bottom: 4px; }
    .content-link:hover { background: #f8f9ff; }
    .content-link .link-icon { font-size: 24px; margin-right: 12px; }
    .content-link .link-text { flex: 1; }
    .content-link .link-text h4 { font-size: 15px; margin-bottom: 2px; }
    .content-link .link-text p { font-size: 12px; color: #999; }
    .content-link .link-arrow { color: #ccc; font-size: 18px; }
    .quick-links { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <h1>ğŸŒ™ Twilight Admin</h1>
    <div class="header-right">
      <span>æ¬¢è¿, {username}</span>
      <a href="/" target="_blank">è®¿é—®å‰å°</a>
      <button id="logoutBtn">é€€å‡ºç™»å½•</button>
    </div>
  </header>
  <nav class="admin-nav">
    <a href="/admin/" class="active">ä»ªè¡¨ç›˜</a>
    <a href="/admin/posts/">æ–‡ç« ç®¡ç†</a>
    <a href="/admin/content/?type=projects">é¡¹ç›®ç®¡ç†</a>
    <a href="/admin/content/?type=skills">æŠ€èƒ½ç®¡ç†</a>
    <a href="/admin/content/?type=timeline">æ—¶é—´çº¿</a>
    <a href="/admin/content/?type=diary">æ—¥è®°ç®¡ç†</a>
    <a href="/admin/content/?type=albums">ç›¸å†Œç®¡ç†</a>
    <a href="/admin/content/?type=friends">å‹é“¾ç®¡ç†</a>
    <a href="/admin/content/?type=navigation">å¯¼èˆªç®¡ç†</a>
    <a href="/admin/users/">ç”¨æˆ·ç®¡ç†</a>
  </nav>
  <div class="admin-content">
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-label">æ–‡ç« </div><div class="stat-value" id="statPosts">-</div></div>
      <div class="stat-card"><div class="stat-icon">ğŸš€</div><div class="stat-label">é¡¹ç›®</div><div class="stat-value" id="statProjects">-</div></div>
      <div class="stat-card"><div class="stat-icon">âš¡</div><div class="stat-label">æŠ€èƒ½</div><div class="stat-value" id="statSkills">-</div></div>
      <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">å‹é“¾</div><div class="stat-value" id="statFriends">-</div></div>
      <div class="stat-card"><div class="stat-icon">ğŸ“…</div><div class="stat-label">æ—¶é—´çº¿</div><div class="stat-value" id="statTimeline">-</div></div>
      <div class="stat-card"><div class="stat-icon">ğŸ“–</div><div class="stat-label">æ—¥è®°</div><div class="stat-value" id="statDiary">-</div></div>
    </div>
    <div class="quick-links">
      <div class="section-card">
        <h3>ğŸ“„ å†…å®¹ç®¡ç†</h3>
        <a class="content-link" href="/admin/posts/"><span class="link-icon">ğŸ“</span><span class="link-text"><h4>æ–‡ç« ç®¡ç†</h4><p>ç®¡ç†åšå®¢æ–‡ç« çš„åˆ›å»ºã€ç¼–è¾‘å’Œåˆ é™¤</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=projects"><span class="link-icon">ğŸš€</span><span class="link-text"><h4>é¡¹ç›®ç®¡ç†</h4><p>ç®¡ç†ä½œå“é›†å’Œé¡¹ç›®å±•ç¤º</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=skills"><span class="link-icon">âš¡</span><span class="link-text"><h4>æŠ€èƒ½ç®¡ç†</h4><p>ç®¡ç†æŠ€èƒ½å±•ç¤ºå’Œè¯„çº§</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=timeline"><span class="link-icon">ğŸ“…</span><span class="link-text"><h4>æ—¶é—´çº¿</h4><p>ç®¡ç†æ—¶é—´çº¿äº‹ä»¶</p></span><span class="link-arrow">â†’</span></a>
      </div>
      <div class="section-card">
        <h3>ğŸ”§ å…¶ä»–ç®¡ç†</h3>
        <a class="content-link" href="/admin/content/?type=diary"><span class="link-icon">ğŸ“–</span><span class="link-text"><h4>æ—¥è®°ç®¡ç†</h4><p>ç®¡ç†æ—¥è®°å’ŒåŠ¨æ€</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=albums"><span class="link-icon">ğŸ–¼ï¸</span><span class="link-text"><h4>ç›¸å†Œç®¡ç†</h4><p>ç®¡ç†ç…§ç‰‡ç›¸å†Œ</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=friends"><span class="link-icon">ğŸ‘¥</span><span class="link-text"><h4>å‹é“¾ç®¡ç†</h4><p>ç®¡ç†å‹æƒ…é“¾æ¥</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/content/?type=navigation"><span class="link-icon">ğŸ”—</span><span class="link-text"><h4>å¯¼èˆªç®¡ç†</h4><p>ç®¡ç†å¤–éƒ¨å¯¼èˆªé“¾æ¥</p></span><span class="link-arrow">â†’</span></a>
        <a class="content-link" href="/admin/users/"><span class="link-icon">ğŸ‘¤</span><span class="link-text"><h4>ç”¨æˆ·ç®¡ç†</h4><p>ç®¡ç†ç®¡ç†å‘˜è´¦å·</p></span><span class="link-arrow">â†’</span></a>
      </div>
    </div>
  </div>
  <script is:inline>
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout/', { method: 'POST' });
      window.location.href = '/admin/login/';
    });
    // Load stats
    async function loadStats() {
      try {
        const [postsRes, ...contentRes] = await Promise.all([
          fetch('/api/admin/posts/'),
          fetch('/api/admin/content/?type=projects'),
          fetch('/api/admin/content/?type=skills'),
          fetch('/api/admin/content/?type=friends'),
          fetch('/api/admin/content/?type=timeline'),
          fetch('/api/admin/content/?type=diary'),
        ]);
        const postsData = await postsRes.json();
        const [projectsData, skillsData, friendsData, timelineData, diaryData] = await Promise.all(contentRes.map(r => r.json()));
        document.getElementById('statPosts').textContent = postsData.success ? postsData.posts.length : '0';
        document.getElementById('statProjects').textContent = projectsData.success ? projectsData.items.length : '0';
        document.getElementById('statSkills').textContent = skillsData.success ? skillsData.items.length : '0';
        document.getElementById('statFriends').textContent = friendsData.success ? friendsData.items.length : '0';
        document.getElementById('statTimeline').textContent = timelineData.success ? timelineData.items.length : '0';
        document.getElementById('statDiary').textContent = diaryData.success ? diaryData.items.length : '0';
      } catch { /* ignore */ }
    }
    loadStats();
  </script>
</body>
</html>
